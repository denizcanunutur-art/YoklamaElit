<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Elit Eğitim Kurumu - Yoklama Sistemi</title>
<style>
:root{--red:#e74c3c;--blue:#2d6cdf;--green:#25d366;--muted:#f7f7f7;--gray:#bdbdbd;}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Montserrat",Arial,sans-serif;}
body,html{height:100%;margin:0;}
body{background:url('IMG_4035.JPG') center/cover no-repeat;background-size:cover;color:#222;display:flex;justify-content:center;align-items:center;}
#loginPanel{background:rgba(255,255,255,0.95);padding:40px 30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.3);text-align:center;max-width:360px;width:90%;}
#loginPanel img{width:120px;height:auto;margin-bottom:20px;}
#loginPanel h2{margin-bottom:24px;font-size:24px;color:#222;font-weight:700;}
.btn{display:block;width:100%;padding:12px 0;margin:10px 0;border:none;border-radius:10px;font-weight:700;font-size:16px;cursor:pointer;transition:0.3s;}
.btn-primary{background:var(--blue);color:#fff;box-shadow:0 5px 15px rgba(0,0,0,0.2);}
.btn-primary:hover{background:#1c4fcc;transform:translateY(-2px);}
#passwordPanel{display:none;flex-direction:column;align-items:center;gap:10px;margin-top:10px;}
#passwordPanel input{padding:10px;width:80%;border-radius:8px;border:1px solid #dcdcdc;font-size:16px;}
main{display:none;padding:20px;width:100%;max-width:1200px;margin:0 auto;}
.panel{background:rgba(255,255,255,0.96);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.05);margin-bottom:20px;}
h3{margin:0 0 10px 0;font-size:18px;}
.table-wrap{max-height:440px;overflow-y:auto;overflow-x:hidden;border-radius:6px;border:1px solid #e6e6e6;background:#fff;}
table{width:100%;border-collapse:collapse;}
thead th{position:sticky;top:0;background:var(--muted);border-bottom:1px solid #e6e6e6;padding:10px;font-weight:700;text-align:left;}
tbody td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left;}
tbody tr:hover{background:rgba(0,0,0,0.03);}
.status-cell{width:110px;text-align:center;cursor:pointer;border-radius:6px;padding:6px;font-weight:700;}
.status-empty{background:transparent;color:#333;}
.status-absent{background:#ffd8d8;color:#800;}
.status-present{background:#d6ffd9;color:#064;}
.btn-wa{background:var(--green);color:#fff;}
#parentTableWrap{display:none;}
.parent-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;max-height:500px;overflow-y:auto;}
.parent-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);position:relative;display:flex;flex-direction:column;align-items:start;gap:6px;}
.status-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle;}
.status-present{background:var(--green);}
.status-absent{background:var(--red);}
.parent-search{margin-bottom:12px;padding:8px;width:100%;border-radius:8px;border:1px solid #dcdcdc;font-size:16px;}
#classButtons{display:flex;flex-wrap:wrap;justify-content:center;margin-bottom:12px;}
.btn-class{background:#eee;color:var(--blue);margin:2px;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:700;}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:40}
#panel{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:50;width:92%;max-width:520px}
#panel .panel-inner{background:#fff;padding:18px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,0.2)}
.panel-inner input{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #dcdcdc}
@media(max-width:500px){#loginPanel{padding:30px 20px;} .btn{font-size:14px;padding:10px 0;}}
</style>
</head>
<body>

<div id="loginPanel">
  <img src="elit_logo.png" alt="Elit Logo">
  <h2>Giriş Seçenekleri</h2>
  <button class="btn btn-primary" id="teacherBtn">Öğretmen Girişi</button>
  <button class="btn btn-primary" id="parentBtn">Veli Girişi</button>

  <div id="passwordPanel">
    <input type="password" id="teacherPassword" placeholder="Şifreyi girin"/>
    <button class="btn btn-primary" id="teacherLoginBtn">Giriş</button>
  </div>
</div>

<main>
  <!-- Öğretmen yoklama paneli -->
  <section class="panel" id="yoklamaPanel">
    <h3>Etüt Yoklama Listesi</h3>
    <button class="btn btn-primary" id="btnPanel">Öğrenci Ekle / Çıkar</button>
    <div id="classButtons"></div>
    <div class="table-wrap">
      <table id="studentsTable">
        <thead><tr><th>İsim</th><th>Sınıf</th><th>Durum</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Veli paneli -->
  <section class="panel" id="parentTableWrap">
    <input type="text" id="parentSearch" class="parent-search" placeholder="Öğrenci ara..."/>
    <div class="parent-cards" id="parentCards"></div>
  </section>
</main>

<!-- Öğrenci ekleme paneli -->
<div id="overlay"></div>
<div id="panel" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel-inner">
    <h3>Öğrenci Yönetimi</h3>
    <input id="newName" type="text" placeholder="Ad Soyad" />
    <input id="newClass" type="text" placeholder="Sınıf (örn: 11Say)" />
    <input id="newPhone" type="text" placeholder="Telefon (örn +90...)" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-primary" id="btnAdd">Ekle</button>
      <button class="btn" id="btnClear">Temizle</button>
    </div>
    <hr style="margin:12px 0">
    <div style="font-weight:700;margin-bottom:6px">Öğrenci Sil</div>
    <input id="removeName" type="text" placeholder="Silinecek öğrenci adı" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-danger" id="btnRemove">Sil</button>
      <button class="btn" id="btnClose">Kapat</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBka7ReTV8sGjR9GAsJUDkksLSCTHCV9Mk",
  authDomain: "elit-yoklama.firebaseapp.com",
  projectId: "elit-yoklama",
  storageBucket: "elit-yoklama.firebasestorage.app",
  messagingSenderId: "30260081027",
  appId: "1:30260081027:web:9332093cbc19d605d506b6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let isParentMode = false;
let activeClassFilter = null;
let students = [];
let statuses = {};

async function loadStudents(){
  students = [];
  const querySnapshot = await getDocs(collection(db,"students"));
  querySnapshot.forEach(docSnap=>{
    const data = docSnap.data();
    students.push(data);
    statuses[data.name] = data.status || "";
  });
  if(isParentMode) renderParentCards();
  else { renderClassButtons(); renderStudentsTable(); document.getElementById("yoklamaPanel").style.display="block";}
}

async function updateStatus(name,newStatus){
  statuses[name] = newStatus;
  const studentRef = doc(db,"students",name);
  await updateDoc(studentRef,{status:newStatus||""});
  if(isParentMode) renderParentCards();
  else renderStudentsTable();
}

function renderClassButtons(){
  const container = document.getElementById("classButtons"); container.innerHTML="";
  const classes = [...new Set(students.map(s=>s.class))].sort();
  classes.forEach(cls=>{
    const btn = document.createElement("button");
    btn.textContent = cls; btn.className="btn-class";
    if(activeClassFilter===cls){btn.style.backgroundColor="var(--blue)";btn.style.color="#fff";}
    btn.addEventListener("click",()=>{ activeClassFilter = (activeClassFilter===cls)?null:cls; renderClassButtons(); renderStudentsTable(); });
    container.appendChild(btn);
  });
}

function renderStudentsTable(){
  const tbody = document.querySelector("#studentsTable tbody"); tbody.innerHTML="";
  students.filter(s=>!activeClassFilter||s.class===activeClassFilter).forEach(s=>{
    const tr=document.createElement("tr");
    const tdName=document.createElement("td"); tdName.className="name"; tdName.textContent=s.name;
    const tdClass=document.createElement("td"); tdClass.textContent=s.class;
    const tdStatus=document.createElement("td"); tdStatus.className="status-cell";
    const st = statuses[s.name]||"";
    tdStatus.classList.remove("status-empty","status-absent","status-present");
    if(!st) tdStatus.classList.add("status-empty");
    else if(st==="absent") tdStatus.classList.add("status-absent");
    else if(st==="present") tdStatus.classList.add("status-present");
    tdStatus.textContent = st ? (st==="absent"?"Yok":"Var"):"-";
    tdStatus.addEventListener("click",()=>{ let next=(!st)?"absent":(st==="absent"?"present":null); updateStatus(s.name,next); });
    tr.appendChild(tdName); tr.appendChild(tdClass); tr.appendChild(tdStatus);
    tbody.appendChild(tr);
  });
}

// Parent rendering
function renderParentCards(){
  const container = document.getElementById("parentCards"); container.innerHTML="";
  const searchVal = document.getElementById("parentSearch").value.toLowerCase();
  students.filter(s=>s.name.toLowerCase().includes(searchVal)).forEach(s=>{
    const div = document.createElement("div"); div.className="parent-card";
    const dot = document.createElement("span"); dot.className="status-dot"; dot.classList.add(statuses[s.name]==="present"?"status-present":"status-absent");
    const nameEl = document.createElement("div"); nameEl.textContent=s.name;
    const classEl = document.createElement("div"); classEl.textContent=s.class;
    div.appendChild(dot); div.appendChild(nameEl); div.appendChild(classEl);
    container.appendChild(div);
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  // Login buttons
  const loginPanel = document.getElementById("loginPanel");
  const teacherBtn = document.getElementById("teacherBtn");
  const parentBtn = document.getElementById("parentBtn");
  const passwordPanel = document.getElementById("passwordPanel");
  const teacherLoginBtn = document.getElementById("teacherLoginBtn");
  const teacherPassword = document.getElementById("teacherPassword");

  teacherBtn.addEventListener("click",()=>{ passwordPanel.style.display="flex"; });
  parentBtn.addEventListener("click",()=>{
    isParentMode = true;
    loginPanel.style.display="none";
    document.getElementById("parentTableWrap").style.display="block";
    loadStudents();
  });
  teacherLoginBtn.addEventListener("click",()=>{
    if(teacherPassword.value==="elit"){
      isParentMode = false;
      loginPanel.style.display="none";
      loadStudents();
    } else alert("Şifre yanlış!");
  });

  // Parent search
  document.getElementById("parentSearch").addEventListener("input",renderParentCards);

  // Öğrenci yönetim paneli
  document.getElementById("btnPanel").addEventListener("click",()=>{ document.getElementById("overlay").style.display="block"; document.getElementById("panel").style.display="block"; });
  document.getElementById("overlay").addEventListener("click",()=>{ document.getElementById("overlay").style.display="none"; document.getElementById("panel").style.display="none"; });
  document.getElementById("btnClose").addEventListener("click",()=>{ document.getElementById("overlay").style.display="none"; document.getElementById("panel").style.display="none"; });
  document.getElementById("btnClear").addEventListener("click",()=>{ document.getElementById("newName").value=""; document.getElementById("newClass").value=""; document.getElementById("newPhone").value=""; });
  document.getElementById("btnAdd").addEventListener("click",async ()=>{
    const name = document.getElementById("newName").value.trim();
    const cls = document.getElementById("newClass").value.trim();
    const phone = document.getElementById("newPhone").value.trim();
    if(!name||!cls){alert("İsim ve sınıf girin."); return;}
    const exists = students.some(s=>s.name.toLowerCase()===name.toLowerCase());
    if(exists){alert("Öğrenci zaten var."); return;}
    const newStudent = {name,class:cls,phone,status:""};
    await setDoc(doc(db,"students",name),newStudent);
    students.push(newStudent); renderClassButtons(); renderStudentsTable();
    document.getElementById("newName").value=""; document.getElementById("newClass").value=""; document.getElementById("newPhone").value="";
    document.getElementById("overlay").style.display="none"; document.getElementById("panel").style.display="none";
  });
  document.getElementById("btnRemove").addEventListener("click",async ()=>{
    const name = document.getElementById("removeName").value.trim();
    if(!name){alert("İsim girin"); return;}
    const idx = students.findIndex(s=>s.name.toLowerCase()===name.toLowerCase());
    if(idx===-1){alert("Öğrenci bulunamadı"); return;}
    await deleteDoc(doc(db,"students",students[idx].name));
    students.splice(idx,1); renderClassButtons(); renderStudentsTable();
    document.getElementById("removeName").value=""; document.getElementById("overlay").style.display="none"; document.getElementById("panel").style.display="none";
  });
});
</script>
</body>
</html>
